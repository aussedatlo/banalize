#!/bin/bash

# Script to generate random IP addresses and append them to a file
# Usage: ./generate-ips <file_path> <nb> <timing>

# Check if correct number of arguments are provided
if [ $# -ne 3 ]; then
    echo "Usage: $0 <file_path> <nb> <timing>"
    echo "  file_path: Path to the file where IPs will be appended"
    echo "  nb:        Number of IP addresses to generate"
    echo "  timing:    Time interval in milliseconds between each IP addition"
    exit 1
fi

FILE_PATH="$1"
NB="$2"
TIMING="$3"

# Validate that nb is a positive integer
if ! [[ "$NB" =~ ^[0-9]+$ ]] || [ "$NB" -le 0 ]; then
    echo "Error: <nb> must be a positive integer"
    exit 1
fi

# Validate that timing is a non-negative number
if ! [[ "$TIMING" =~ ^[0-9]+(\.[0-9]+)?$ ]] || [ "$(echo "$TIMING < 0" | bc 2>/dev/null || echo 0)" -eq 1 ]; then
    echo "Error: <timing> must be a non-negative number"
    exit 1
fi

# Function to generate a random IP address
generate_random_ip() {
    echo "$((RANDOM % 256)).$((RANDOM % 256)).$((RANDOM % 256)).$((RANDOM % 256))"
}

# Create file if it doesn't exist
touch "$FILE_PATH" || {
    echo "Error: Cannot create or access file: $FILE_PATH"
    exit 1
}

# Generate a random IP address once
random_ip=$(generate_random_ip)

# Capture start time in nanoseconds
start_time=$(date +%s%N)

# Append the same IP address nb times
for ((i=1; i<=NB; i++)); do
    echo "index: $i, ip: $random_ip" >> "$FILE_PATH"
    
    # Calculate elapsed time in milliseconds
    current_date_time=$(date -u +"%Y-%m-%dT%H:%M:%S.%6NZ")
    current_time=$(date +%s%N)
    elapsed_ms=$(( (current_time - start_time) / 1000000 ))
    
    echo "$current_date_time Added IP $i/$NB: $random_ip (+${elapsed_ms}ms)"
    
    # Wait for the specified timing interval (except after the last IP)
    # Convert milliseconds to microseconds for usleep command
    if [ $i -lt $NB ]; then
        usleep_duration=$(awk "BEGIN {printf \"%.0f\", $TIMING * 1000}")
        usleep "$usleep_duration"
    fi
done

echo "Done! Added $NB IP addresses to $FILE_PATH"

